name: Catalog Sync

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: catalog-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Sync catalog
        run: npm run sync

      - name: Validate policy and data
        run: |
          npm run lint
          npm run test
          npm run build
          npm run whitelist:verify -- --allow-failures

      - name: Catalog summary
        run: |
          node -e '
            const fs=require("fs");
            const items=JSON.parse(fs.readFileSync("data/catalog/items.json","utf8"));
            const byKind=items.reduce((acc,item)=>{acc[item.kind]=(acc[item.kind]||0)+1;return acc;},{});
            const lines=[
              "## Catalog Sync Summary",
              `- Items: ${items.length}`,
              `- Skills: ${byKind["skill"]||0}`,
              `- MCPs: ${byKind["mcp"]||0}`,
              `- Claude plugins: ${byKind["claude-plugin"]||0}`,
              `- Copilot extensions: ${byKind["copilot-extension"]||0}`
            ];
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, lines.join("\\n") + "\\n");
          '

      - name: Commit updated catalog artifacts
        run: |
          if git diff --quiet -- data/catalog data/quarantine data/whitelist; then
            echo "No catalog updates to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/catalog data/quarantine data/whitelist
          git commit -m "chore(catalog): daily sync refresh"
          git push
