name: PR CI Failure Notify

on:
  workflow_run:
    workflows:
      - CI
      - Security / CodeQL
      - Security / Dependency Review
      - Security / SBOM + Trivy
      - Security / Secrets
    types: [completed]

permissions:
  actions: read
  contents: read
  pull-requests: write

concurrency:
  group: pr-ci-failure-notify-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

jobs:
  notify:
    name: Comment Failed CI
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Upsert CI failure comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- ci-failure-notify -->';
            const run = context.payload.workflow_run;
            const prs = run.pull_requests || [];
            if (!prs.length) {
              core.info('No pull request linked to this failed workflow run.');
              return;
            }

            const prNumber = prs[0].number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const jobs = await github.paginate(
              github.rest.actions.listJobsForWorkflowRun,
              {
                owner,
                repo,
                run_id: run.id,
                per_page: 100
              }
            );

            const failedConclusions = new Set(['failure', 'timed_out', 'cancelled', 'startup_failure', 'action_required']);
            const failedJobs = jobs.filter((job) => failedConclusions.has(job.conclusion || ''));
            const jobLines = failedJobs.length
              ? failedJobs.map((job) => `- ${job.name}: ${job.html_url}`).join('\n')
              : '- No failed job URLs found in run metadata.';

            const body = [
              marker,
              'CI failed for this PR.',
              '',
              `- Workflow: ${run.name}`,
              `- Run: ${run.html_url}`,
              '',
              'Failed jobs:',
              jobLines,
              '',
              'Tip: run `gh pr checks ' + prNumber + '` and inspect failing logs.'
            ].join('\n');

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100
            });

            const existing = comments.find(
              (comment) =>
                comment.user?.login === 'github-actions[bot]' &&
                typeof comment.body === 'string' &&
                comment.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body
              });
            }

            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: ['ci-failed']
              });
            } catch (error) {
              core.warning(`Could not apply ci-failed label: ${error.message}`);
            }
