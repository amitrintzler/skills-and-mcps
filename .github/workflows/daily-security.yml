name: Daily Security

on:
  schedule:
    - cron: '12 3 * * *'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: daily-security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  daily-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Sync latest catalog
        run: npm run sync

      - name: Verify whitelist
        run: npm run dev -- whitelist verify --allow-failures

      - name: Apply quarantine from latest report
        run: |
          REPORT=$(ls -1t data/security-reports/*/report.json | head -n 1)
          echo "Latest report: $REPORT"
          npm run quarantine:apply -- --report "$REPORT"

      - name: Daily security summary
        run: |
          REPORT=$(ls -1t data/security-reports/*/report.json | head -n 1)
          node -e '
            const fs=require("fs");
            const report=JSON.parse(fs.readFileSync(process.argv[1],"utf8"));
            const lines=[
              "## Daily Security Summary",
              `- Report: ${process.argv[1]}`,
              `- Passed whitelist entries: ${report.passed.length}`,
              `- Failed whitelist entries: ${report.failed.length}`,
              `- Stale registries: ${report.staleRegistries?.length ?? 0}`
            ];
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, lines.join("\\n") + "\\n");
          ' "$REPORT"

      - name: Create quarantine PR
        id: create_pr
        continue-on-error: true
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(security): daily quarantine update"
          title: "chore(security): daily quarantine update"
          body: |
            Automated daily security verification updated whitelist/quarantine state.
            - Synced catalog
            - Re-ran whitelist risk/injection checks
            - Applied quarantine for failing entries
          branch: chore/daily-security-quarantine
          base: main
          delete-branch: true

      - name: Quarantine PR status
        if: always()
        run: |
          {
            echo "## Quarantine PR Step"
            echo "- Outcome: ${{ steps.create_pr.outcome }}"
            echo "- Note: If this is \`failure\`, enable 'Allow GitHub Actions to create and approve pull requests' in repo settings."
          } >> "$GITHUB_STEP_SUMMARY"
